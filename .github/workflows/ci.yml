name: CI/CD Pipeline Completo

on:
  push:
    branches: [ "main" ]

jobs:
  # --- ETAPA 1: PRUEBAS (CI) ---
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Descargar cÃ³digo
      uses: actions/checkout@v4

    - name: Configurar PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2' # Recomiendo 8.2 para asegurar estabilidad
        extensions: mbstring, xml, bcmath, sqlite3

    - name: Instalar Dependencias
      run: composer install -q --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist

    - name: Copiar .env
      run: cp .env.example .env && php artisan key:generate

    - name: Crear Base de Datos de Prueba
      run: |
        touch database/database.sqlite
        php artisan migrate --force

    - name: Ejecutar Pruebas (PHPUnit)
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
      run: php artisan test

  # --- ETAPA 2: CONSTRUIR Y SUBIR (Build & Push) ---
  build:
    needs: test # Solo si los tests pasan
    runs-on: ubuntu-latest
    steps:
      - name: Descargar cÃ³digo
        uses: actions/checkout@v4

      - name: Login en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Construir Imagen Docker
        run: docker build -t ${{ secrets.DOCKER_USERNAME }}/api-laravel:latest .

      - name: Escaneo de Seguridad (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ secrets.DOCKER_USERNAME }}/api-laravel:latest'
          format: 'table'
          exit-code: '1' # Falla si hay vulnerabilidades crÃ­ticas (Requisito RÃºbrica)
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'

      - name: Subir a Docker Hub
        run: docker push ${{ secrets.DOCKER_USERNAME }}/api-laravel:latest

  # --- ETAPA 3: DESPLIEGUE CONTINUO (CD con Ansible) ---
  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Descargar cÃ³digo (para acceder a la carpeta infraestructura)
        uses: actions/checkout@v4

      - name: Instalar Ansible
        run: pip install ansible

      - name: Crear Llave SSH desde Secretos
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Desactivar chequeo estricto de host
        # Esto evita que el pipeline se congele preguntando "Are you sure you want to connect?"
        run: export ANSIBLE_HOST_KEY_CHECKING=False

      - name: Ejecutar Playbook de Ansible ðŸš€
        env:
          ANSIBLE_HOST_KEY_CHECKING: 'False'
        run: |
          ansible-playbook -i infraestructura-laravel/inventory \
          infraestructura-laravel/playbook.yml \
          --private-key key.pem \
          --extra-vars "docker_user=${{ secrets.DOCKER_USERNAME }}"